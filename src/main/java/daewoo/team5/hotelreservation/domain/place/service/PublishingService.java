package daewoo.team5.hotelreservation.domain.place.service;

import daewoo.team5.hotelreservation.domain.place.dto.AddressDTO;
import daewoo.team5.hotelreservation.domain.place.dto.FileDTO;
import daewoo.team5.hotelreservation.domain.place.dto.PublishingDTO;
import daewoo.team5.hotelreservation.domain.place.dto.RoomDTO;
import daewoo.team5.hotelreservation.domain.place.entity.*;
import daewoo.team5.hotelreservation.domain.place.repository.*;
import daewoo.team5.hotelreservation.global.exception.ApiException;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalTime;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class PublishingService {

    private final PlaceCategoryRepository placeCategoryRepository;
    private final PlaceRepository repository;
    private final RoomRepository roomRepository;
    private final PlaceAddressRepository placeAddressRepository;
    private final FileRepository fileRepository;
    private final AmentiesRepository amentiesRepository;


    @Transactional
    public Places registerHotel(PublishingDTO dto) {
        PlaceCategory placeCategory = placeCategoryRepository.findById(Math.toIntExact(dto.getCategoryId()))
                .orElseThrow(() -> new ApiException(HttpStatus.NOT_FOUND, "Ïπ¥ÌÖåÍ≥†Î¶¨ ÏóÜÏùå", ""));


        List<Amenity> amenityList = new ArrayList<>();
        if (dto.getAmenityIds() != null && !dto.getAmenityIds().isEmpty()) {
            amenityList = amentiesRepository.findAllById(dto.getAmenityIds());
        }
        Places place = Places.builder()
                .name(dto.getHotelName())
                .description(dto.getDescription())
                .checkOut(LocalTime.parse(dto.getCheckOut()))
                .checkIn(LocalTime.parse(dto.getCheckIn()))
                .amenities(amenityList)
                .category(placeCategory)
                .build();

        repository.save(place);

        List<File> allFilesToSave = new ArrayList<>();

        if (dto.getHotelImages() != null) {
            dto.getHotelImages().forEach(imgDto -> {
                String url = imgDto.getUrl();
                allFilesToSave.add(File.builder()
                        .domain("place")
                        .domainFileId(place.getId())
                        .filename(UUID.randomUUID().toString())
                        .extension(extractExtensionFromDataUrl(url))
                        .filetype("image")

                        .url(url)
                        .userId(dto.getUserId())
                        .build());
            });
        }

        List<Room> rooms = dto.getRooms().stream()
                .map(roomDto -> Room.builder()
                        .roomType(roomDto.getRoomType() != null && !roomDto.getRoomType().isEmpty()
                                ? roomDto.getRoomType()
                                : "single")
                        .roomType(roomDto.getRoomType())
                        .bedType(roomDto.getBedType())
                        .price(BigDecimal.valueOf(roomDto.getMinPrice()))
                        .capacityPeople(roomDto.getCapacityPeople())
                        .status(Room.Status.AVAILABLE)
                        .place(place)
                        .build())
                .collect(Collectors.toList());

        List<Room> savedRooms = roomRepository.saveAll(rooms);

        for (int i = 0; i < dto.getRooms().size(); i++) {
            RoomDTO roomDto = dto.getRooms().get(i);
            Room savedRoom = savedRooms.get(i);
            if (roomDto.getImages() != null) {
                roomDto.getImages().forEach(imgDto -> {
                    String url = imgDto.getUrl();
                    allFilesToSave.add(File.builder()
                            .domain("room")
                            .domainFileId(savedRoom.getId())
                            .filename(UUID.randomUUID().toString())
                            .extension(extractExtensionFromDataUrl(url))
                            .filetype("image")
                            .url(url)
                            .userId(dto.getUserId())
                            .build());
                });
            }
        }

        if (!allFilesToSave.isEmpty()) {
            fileRepository.saveAll(allFilesToSave);
        }

        List<PlaceAddress> addresses = dto.getAddressList().stream()
                .map(addressDto -> PlaceAddress.builder()
                        .place(place)
                        .sido(addressDto.getSido())
                        .sigungu(addressDto.getSigungu())
                        .town(addressDto.getTown())
                        .roadName(addressDto.getRoadName())
                        .postalCode(addressDto.getPostalCode())
                        .detailAddress(addressDto.getDetailAddress())
                        .lat(BigDecimal.valueOf(221))
                        .lng(BigDecimal.valueOf(213))
                        .build())
                .collect(Collectors.toList());

        placeAddressRepository.saveAll(addresses);

        return place;
    }

    // PublishingService.java

    @Transactional
    public Places updateHotel(Long placeId, PublishingDTO dto) {
        // 1. ÏàòÏ†ïÌï† ÏàôÏÜå ÏóîÌã∞Ìã∞Î•º Ï∞æÏäµÎãàÎã§.
        Places place = repository.findById(placeId)
                .orElseThrow(() -> new ApiException(HttpStatus.NOT_FOUND, "ÏàòÏ†ïÌï† ÏàôÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.", "ID: " + placeId));

        // 2. Ïπ¥ÌÖåÍ≥†Î¶¨ ÏóîÌã∞Ìã∞Î•º Ï∞æÏäµÎãàÎã§.
        PlaceCategory placeCategory = placeCategoryRepository.findById(Math.toIntExact(dto.getCategoryId()))
                .orElseThrow(() -> new ApiException(HttpStatus.NOT_FOUND, "Ïπ¥ÌÖåÍ≥†Î¶¨ ÏóÜÏùå", ""));

        // 3. Ìò∏ÌÖîÏùò Í∏∞Î≥∏ Ï†ïÎ≥¥Î•º ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§.
        place.updateDetails(
                dto.getHotelName(),
                dto.getDescription(),
                LocalTime.parse(dto.getCheckIn()),
                LocalTime.parse(dto.getCheckOut()),
                placeCategory
        );

        // 4. Ìé∏ÏùòÏãúÏÑ§(Amenity) Î™©Î°ùÏùÑ ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§.
        if (dto.getAmenityIds() != null) {
            List<Amenity> updatedAmenities = amentiesRepository.findAllById(dto.getAmenityIds());
            place.setAmenities(updatedAmenities);
        } else {
            place.getAmenities().clear();
        }

        // 5. Í∏∞Ï°¥Ïùò Ïó∞Í¥Ä Îç∞Ïù¥ÌÑ∞(Ïù¥ÎØ∏ÏßÄ, Í∞ùÏã§, Ï£ºÏÜå)Î•º Î™®Îëê ÏÇ≠Ï†úÌï©ÎãàÎã§.
        List<Long> existingRoomIds = roomRepository.findByPlaceId(placeId).stream()
                .map(Room::getId).collect(Collectors.toList());
        if (!existingRoomIds.isEmpty()) {
            fileRepository.deleteByDomainAndDomainFileIdIn("room", existingRoomIds);
        }
        fileRepository.deleteByDomainAndDomainFileId("place", placeId);
        roomRepository.deleteByPlaceId(placeId);
        placeAddressRepository.deleteByPlaceId(placeId);

        // üí° [Ï∂îÍ∞Ä] 6. DTOÏóê Îã¥Í≤®Ïò® ÏÉà Ï†ïÎ≥¥Î°ú Ïó∞Í¥Ä Îç∞Ïù¥ÌÑ∞Î•º Îã§Ïãú ÏÉùÏÑ±Ìï©ÎãàÎã§.
        // Ïù¥ Î∂ÄÎ∂ÑÏùÄ registerHotelÏùò Î°úÏßÅÍ≥º ÎèôÏùºÌï©ÎãàÎã§.
        List<File> allFilesToSave = new ArrayList<>();

        if (dto.getHotelImages() != null) {
            dto.getHotelImages().forEach(imgDto -> {
                String url = imgDto.getUrl();
                allFilesToSave.add(File.builder()
                        .domain("place")
                        .domainFileId(place.getId())
                        .filename(UUID.randomUUID().toString())
                        .extension(extractExtensionFromDataUrl(url))
                        .filetype("image")
                        .url(url)
                        .userId(dto.getUserId())
                        .build());
            });
        }

        List<Room> rooms = dto.getRooms().stream()
                .map(roomDto -> Room.builder()
                        .roomType(roomDto.getRoomType())
                        .bedType(roomDto.getBedType())
                        .price(BigDecimal.valueOf(roomDto.getMinPrice()))
                        .capacityPeople(roomDto.getCapacityPeople())
                        .status(Room.Status.AVAILABLE)
                        .place(place)
                        .build())
                .collect(Collectors.toList());

        List<Room> savedRooms = roomRepository.saveAll(rooms);

        for (int i = 0; i < dto.getRooms().size(); i++) {
            RoomDTO roomDto = dto.getRooms().get(i);
            Room savedRoom = savedRooms.get(i);
            if (roomDto.getImages() != null) {
                roomDto.getImages().forEach(imgDto -> {
                    String url = imgDto.getUrl();
                    allFilesToSave.add(File.builder()
                            .domain("room")
                            .domainFileId(savedRoom.getId())
                            .filename(UUID.randomUUID().toString())
                            .extension(extractExtensionFromDataUrl(url))
                            .filetype("image")
                            .url(url)
                            .userId(dto.getUserId())
                            .build());
                });
            }
        }

        if (!allFilesToSave.isEmpty()) {
            fileRepository.saveAll(allFilesToSave);
        }

        List<PlaceAddress> addresses = dto.getAddressList().stream()
                .map(addressDto -> PlaceAddress.builder()
                        .place(place)
                        .sido(addressDto.getSido())
                        .sigungu(addressDto.getSigungu())
                        .town(addressDto.getTown())
                        .roadName(addressDto.getRoadName())
                        .postalCode(addressDto.getPostalCode())
                        .detailAddress(addressDto.getDetailAddress())
                        .lat(BigDecimal.valueOf(221))
                        .lng(BigDecimal.valueOf(213))
                        .build())
                .collect(Collectors.toList());

        placeAddressRepository.saveAll(addresses);

        return place;
    }

    private String extractExtensionFromDataUrl(String dataUrl) {
        if (dataUrl == null || !dataUrl.startsWith("data:image/")) {
            return "jpg";
        }
        Pattern pattern = Pattern.compile("data:image/(\\w+);base64,.*");
        Matcher matcher = pattern.matcher(dataUrl);
        if (matcher.find()) {
            return matcher.group(1);
        }
        return "jpg";
    }

    public List<PublishingDTO> getAllHotels(Long ownerId) {
        return repository.findAllByOwnerId(ownerId).stream()
                .map(p -> {
                    String imageUrl = fileRepository.findFirstByDomainAndDomainFileId("place", p.getId())
                            .map(File::getUrl)
                            .orElse(null);
                    AddressDTO addressDto = placeAddressRepository.findFirstByPlaceId(p.getId())
                            .map(addr -> AddressDTO.builder()
                                    .sido(addr.getSido())
                                    .sigungu(addr.getSigungu())
                                    .town(addr.getTown())
                                    .build())
                            .orElse(null);

                    Long categoryId = p.getCategory() != null ? (long)p.getCategory().getId() : null;


                    return PublishingDTO.builder()
                            .id(p.getId())
                            .hotelName(p.getName())
                            .description(p.getDescription())
                            .minPrice(p.getMinPrice())
                            .checkIn(p.getCheckIn().toString())
                            .checkOut(p.getCheckOut().toString())
                            .address(addressDto)
                            .images(imageUrl != null ? List.of(imageUrl) : List.of())
                            .CategoryId(categoryId)
                            .build();
                })
                .collect(Collectors.toList());
    }

    public PublishingDTO getHotel(Long id) {
        Places place = repository.findById(id)
                .orElseThrow(() -> new RuntimeException("Ìï¥Îãπ ÏàôÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. id=" + id));

        List<PlaceAddress> addresses = placeAddressRepository.findByPlaceId(id);
        List<Room> rooms = roomRepository.findByPlaceId(id);

        List<File> hotelImages = fileRepository.findByDomainAndDomainFileId("place", id);
        List<Long> roomIds = rooms.stream().map(Room::getId).collect(Collectors.toList());
        List<File> roomImages = fileRepository.findByDomainAndDomainFileIdIn("room", roomIds);

        List<AddressDTO> addressDTOs = addresses.stream()
                .map(addr -> AddressDTO.builder()
                        .sido(addr.getSido())
                        .sigungu(addr.getSigungu())
                        .town(addr.getTown())
                        .roadName(addr.getRoadName())
                        .postalCode(addr.getPostalCode())
                        .detailAddress(addr.getDetailAddress())
                        .build())
                .collect(Collectors.toList());

        List<FileDTO> hotelImageDTOs = hotelImages.stream()
                .map(file -> new FileDTO(file.getFilename(), file.getExtension(), file.getUrl()))
                .collect(Collectors.toList());

        List<RoomDTO> roomDTOs = rooms.stream().map(room -> {
            List<FileDTO> currentRoomImages = roomImages.stream()
                    .filter(img -> img.getDomainFileId().equals(room.getId()))
                    .map(file -> new FileDTO(file.getFilename(), file.getExtension(), file.getUrl()))
                    .collect(Collectors.toList());

            return RoomDTO.builder()
                    .roomType(room.getRoomType())
                    .capacityPeople(room.getCapacityPeople())
                    .minPrice(room.getPrice().intValue())
                    .bedType(room.getBedType())
                    .images(currentRoomImages)
                    .build();
        }).collect(Collectors.toList());

        List<Long> amenityIds = place.getAmenities().stream()
                .map(Amenity::getId)
                .collect(Collectors.toList());

        return PublishingDTO.builder()
                .hotelName(place.getName())
                .description(place.getDescription())
                .checkIn(place.getCheckIn().toString())
                .checkOut(place.getCheckOut().toString())
                .capacityRoom(place.getCapacityRoom())
                .CategoryId(place.getCategory().getId())
                .addressList(addressDTOs)
                .hotelImages(hotelImageDTOs)
                .rooms(roomDTOs)
                .amenityIds(amenityIds)
                .build();
    }

    @Transactional
    public void deleteHotel(Long placeId) {
        // 1. ÏàôÏÜå(Place)Í∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
        if (!repository.existsById(placeId)) {
            throw new ApiException(HttpStatus.NOT_FOUND, "ÏÇ≠Ï†úÌï† ÏàôÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.", "ID: " + placeId);
        }

        List<Long> roomIds = roomRepository.findByPlaceId(placeId).stream()
                .map(Room::getId).collect(Collectors.toList());
        if (!roomIds.isEmpty()) {
            fileRepository.deleteByDomainAndDomainFileIdIn("room", roomIds);
        }
        fileRepository.deleteByDomainAndDomainFileId("place", placeId);
        roomRepository.deleteByPlaceId(placeId);
        placeAddressRepository.deleteByPlaceId(placeId);

        /*if (!roomIds.isEmpty()) {
            // üí° [Ï∂îÍ∞Ä] RoomÏùÑ ÏÇ≠Ï†úÌïòÍ∏∞ Ï†ÑÏóê, RoomÏùÑ Ï∞∏Ï°∞ÌïòÎäî ÏòàÏïΩ(Reservation) Îç∞Ïù¥ÌÑ∞Î•º Î®ºÏ†Ä ÏÇ≠Ï†úÌï¥Ïïº Ìï©ÎãàÎã§.
            // Ïù¥ ÎùºÏù∏Ïù¥ ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§!
            dailyPlaceReservationRepository.deleteByRoomIdIn(roomIds);
 Ïù¥Í±∞ Î¨ºÏñ¥Î≥¥Í≥† ÎÑ£Í∏∞Î°ú

            // Í∑∏ Îã§Ïùå, Í∏∞Ï°¥ Î°úÏßÅÎåÄÎ°ú RoomÏùò Ïù¥ÎØ∏ÏßÄÏôÄ Room ÏûêÏ≤¥Î•º ÏÇ≠Ï†úÌï©ÎãàÎã§.
            fileRepository.deleteByDomainAndDomainFileIdIn("room", roomIds);
            roomRepository.deleteByPlaceId(placeId);
        }*/

        // 3. ÎßàÏßÄÎßâÏúºÎ°ú ÏàôÏÜå(Place) ÏûêÏ≤¥Î•º ÏÇ≠Ï†ú
        repository.deleteById(placeId);
    }
}